name: Bump versions

on:
  workflow_dispatch:
  schedule:
    # "At 10:13 on Saturday."
    - cron: '13 10 * * 6'

jobs:
  bump:
    runs-on: macos-latest
    steps:
      - uses: Homebrew/actions/setup-homebrew@master

      - name: Configure git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Bump outdated packages
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_DEVELOPER: 1
        run: |
          # Get outdated packages from livecheck
          outdated=$(brew livecheck --tap="$GITHUB_REPOSITORY" --newer-only --json 2>/dev/null || echo "[]")
          echo "Livecheck output:"
          echo "$outdated" | jq .

          # Extract package names (formulas and casks)
          packages=$(echo "$outdated" | jq -r '.[] | .formula // .cask | select(. != null)')

          if [ -z "$packages" ]; then
            echo "No outdated packages"
            exit 0
          fi

          for pkg in $packages; do
            echo "::group::Bumping $pkg"
            brew bump --open-pr --no-fork "$pkg" || echo "Failed: $pkg"
            echo "::endgroup::"
          done
